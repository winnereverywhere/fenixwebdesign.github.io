(function($){$(function(){$('.wpallimport-download-resource.wpallimport-download-resource-step-two-ftp').on('keypress',function(e){if(e.which===13){e.preventDefault();}});let preloader='<span class="ftp-easing-spinner">\n'+'        <span class="ftp-double-bounce1"></span>\n'+'        <span class="ftp-double-bounce2"></span>\n'+'    </span>';$('.dismiss-wpai-ftp-connection-error').on('click',function(){$(this).parent().hide();});if(!$('body.wpallimport-plugin').length)return;let path;function jstr(str){return JSON.stringify(str);}
function render(data){let list='';if(data['host']){$('input[name="ftp_host"]').val(data['host']);}
if(data['port']){$('input[name="ftp_port"]').val(data['port']);}
if(data['root']){$('input[name="ftp_root"]').val(data['root']);}
list+='<div class="wpai-ftp-browser-grid">';list+='<div class="row col1">';list+='</div>';list+='<div class="row col2">';list+='</div>';list+='<div class="row col3">';list+='</div>';list+='<div class="row col1">';list+='Name';list+='</div>';list+='<div class="row col2">';list+='</div>';list+='<div class="row col3">';list+='Modified';list+='</div>';if(Object.keys(data['data']).length===0){list+='<span class="wpai-ftp-no-files-found">No folders or valid files returned.</span>'}
$.each(data['data'],function(i,val){let add_class='wpai-ftp-browser-link ';list+='<div class="row col2">';if(val['type']==='dir'){list+='<span class="wpai-ftp-browser-folder dashicons dashicons-category"/> ';add_class+='wpai-ftp-browser-dir ';}else{list+='<span class="wpai-ftp-browser-document dashicons dashicons-media-text"/> ';add_class+='wpai-ftp-browser-file '}
list+='<a class="'+add_class+'"data-type="'+val['type']+'" data-dirname="'+val['dirname']+'" data-path="'+val['path']+'" href="javascript:void(0);" >'+val['basename']+'</a>';list+='</div>';list+='<div class="row col3">';list+='</div>';list+='<div class="row col4">';if(typeof val['timestamp']!=='undefined'){list+=new Date(val['timestamp']*1000).toLocaleString("en-US");}
list+='</div>';});list+='</div>';return list;}
$('.wpallimport-ftp-builder').on('click',function(){$('.wpallimport-upload-resource-step-two').hide();$('.wpallimport-choose-file').find('.wpallimport-submit-buttons').hide();loadFiles($('input[name="ftp_path"]').val(),true);});function bindLinks(){$('div.row a').off().on('click',function(){path=$(this).data('path');if(!path){path=$('.wpai-ftp-browser-file-selected').html();}
if($(this).data('type')==='dir'){$('.wpai-ftp-browser-file-selected').html(path);loadFiles(path);bindLinks();}
if($(this).data('type')==='file'){$('.wpai-ftp-browser-file-selected').html(path);$('input[name="ftp_path"]').val(path);$('#wpallimport-ftp-connection-builder').dialog("close");$('.wpallimport-upload-resource-step-two').show();$('.wpallimport-choose-file').find('.wpallimport-submit-buttons').show();}});}
function buildConnection(dir=''){let host=$('input[name="ftp_host"]').val();let user=$('input[name="ftp_username"]').val();let pass=$('input[name="ftp_password"]').val();let port=$('input[name="ftp_port"]').val();let root=$('input[name="ftp_root"]').val();let key=$('textarea[name="ftp_private_key"]').val();return{conn_details:{host:host,user:user,pass:pass,port:port,key:key,root:root},dir:dir};}
function loadFiles(dir='',firstRun=false){$(".wpai-ftp-connection-error").hide();let nonce=$('#wpai-ftp-browser-nonce').val();let target=wpai_home_url+'/wp-load.php?_nonce='+nonce;target+='&action=wpai_public_api&q=ftpbrowser/load';dir=formatPath(dir);let conn=buildConnection(dir);if(firstRun===false){$("#wpallimport-ftp-connection-builder").append(preloader);$(".wpallimport-ftp-connection-builder.ui-dialog-content.ui-widget-content").addClass('ftp-mute-all');}else{$(".wpai-ftp-select-file-button .easing-spinner").show();}
$.ajax({type:'POST',url:target,data:jstr(conn),success:function(data){$("#wpallimport-ftp-connection-builder").html(render(data));bindLinks();if(firstRun){displayDialog();$(".wpai-ftp-select-file-button .easing-spinner").hide();$('#wpallimport-ftp-connection-builder').prev('.ui-dialog-titlebar').hide();if(!$('.wpai-ftp-browser-file-selected').length){$('<div><span  class="wpai-ftp-browser-file-selected"/></div>').insertBefore('.ui-dialog-buttonpane');}
let dir=formatPath($('input[name="ftp_path"]').val());$('.wpai-ftp-browser-file-selected').html(dir);}else{$(".wpallimport-ftp-connection-builder.ui-dialog-content.ui-widget-content").removeClass('ftp-mute-all');}
let path=$('.wpai-ftp-browser-file-selected').html();if(path===''||path===' '||path==='/'||path==='\\'){$(".ftp-connection-builder-dialog").parent().find(":button:contains('Back')").button("disable");}else{$(".ftp-connection-builder-dialog").parent().find(":button:contains('Back')").button("enable");}
$(".ftp-connection-builder-dialog").parent().find(":button:contains('Refresh')").button("enable");bindLinks();},error:function(jqXHR,textStatus,errorThrown){$("#wpai-ftp-connection-error-message").html(jqXHR.responseText);$(".wpai-ftp-connection-error").show();$(".wpai-ftp-select-file-button .easing-spinner").hide();$("#wpallimport-ftp-connection-builder").dialog("close");},contentType:"application/json",dataType:'json'});$('.wpai-ftp-browser-file-selected').html(dir);}
function displayDialog(){$("#wpallimport-ftp-connection-builder").dialog({resizable:true,height:600,width:800,modal:true,draggable:false,dialogClass:"ftp-connection-builder-dialog",open:function(){},buttons:{'Back':function(){$(".ftp-connection-builder-dialog").parent().find(":button:contains('Back')").button("disable");path=$('.wpai-ftp-browser-file-selected').html();if(path.endsWith("/")){path=path.substr(0,path.length-1);}
path=path.substr(0,path.lastIndexOf("/"));loadFiles(path);},'Refresh':function(){$(".ftp-connection-builder-dialog").parent().find(":button:contains('Refresh')").button("disable");path=$('.wpai-ftp-browser-file-selected').html();loadFiles(path);},'Cancel':function(){$(this).dialog("close");},'Select File':function(){$(this).dialog("close");$('.wpallimport-upload-resource-step-two').show();$('.wpallimport-choose-file').find('.wpallimport-submit-buttons').show();}}});$('.ftp-connection-builder-dialog').find('.ui-dialog-buttonset .ui-button:nth-child(4)').hide();}
function formatPath(dir){if(/\W(xml|gzip|zip|csv|tsv|gz|json|txt|dat|psv|sql|xls|xlsx)$/.test(dir)){dir=dir.substr(0,dir.lastIndexOf("/"));}
if(dir!==''){dir+=dir.endsWith("/")?"":"/";}
return dir;}})})(jQuery);